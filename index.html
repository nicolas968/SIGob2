<html>
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="initial-scale=1, maximum-scale=1, user-scalable=no" />
    <title>ArcGIS Maps SDK for JavaScript Tutorials: Display a map</title>

    <style>
        html,
        body,
        #viewDiv {
            padding: 0;
            margin: 0;
            height: 100%;
            width: 100%;
        }
    </style>
    <link rel="stylesheet" href="https://js.arcgis.com/4.27/esri/themes/light/main.css">
    <script src="https://js.arcgis.com/4.27/"></script>
    <script>
        // mock car_position
        const populationServiceUrl = 'https://services.arcgis.com/P3ePLMYs2RVChkJx/arcgis/rest/services/USA_Census_Counties/FeatureServer'

        let carGeometry = {
            type: "point",
            longitude: -122.3321,
            latitude: 47.6062
        };

        require([
            "esri/config",
            "esri/Map",
            "esri/views/MapView",
            "esri/widgets/Search",
            "esri/rest/geometryService",
            "esri/Graphic",
            "esri/rest/support/BufferParameters",
            "esri/layers/FeatureLayer",
            "esri/geometry/Point",
            "esri/rest/support/AreasAndLengthsParameters"
        ], function(
            esriConfig,
            Map,
            MapView,
            Search,
            GeometryService,
            Graphic,
            BufferParameters,
            FeatureLayer,
            Point,
            AreasAndLengthsParameters
        ) {

            esriConfig.apiKey = "AAPK703bbf4bf7b84c8ca9ee01606fe0430cbBQwAqSYc7dXT33E-W7HMyo4iS5Xb0rV-Rwzv6csCU14P0KvFCdrqXQU3jsIu6St";

            const map = new Map({
                basemap: "arcgis-navigation"
            });
            const view = new MapView({
                container: "viewDiv",
                map: map,
                center: [-122.3321,47.6062],
                zoom: 12
            });
            const search = new Search({  //Add Search widget
                view: view
            });
            view.ui.add(search, "top-right"); //Add to the map

            const carSymbol = {
                type: "picture-marker",
                url: "https://static.vecteezy.com/system/resources/previews/001/193/929/original/vintage-car-png.png",
                width: "100px",
                height: "48px"
            }

            const carAttributes = {
                name: "car",
                location: "Seattle"
            }

            const carGraphic = new Graphic({
                geometry: carGeometry,
                symbol: carSymbol,
                attributes: carAttributes
            });

            view.graphics.add(carGraphic);

            // https://services.arcgis.com/P3ePLMYs2RVChkJx/arcgis/rest/services/USA_Census_Counties/FeatureServer

            const populationFeatureLayer = new FeatureLayer({
                url: populationServiceUrl
            });

            map.add(populationFeatureLayer);

            console.log(GeometryService)
            const getCarBuffer = async () => {
                const bufferParams = new BufferParameters({
                    distances: [1/1.77],
                    unit: "kilometers",
                    geodesic: true,
                    bufferSpatialReference: view.spatialReference,
                    outSpatialReference: view.spatialReference,
                    geometries: [carGeometry]
                });
                const bufferedCar = await GeometryService.buffer('http://tasks.arcgisonline.com/arcgis/rest/services/Geometry/GeometryServer', bufferParams)

                console.log(bufferedCar, 'bufferedCar')

                return new Graphic({
                    geometry: bufferedCar[0],
                    symbol: {
                        type: "simple-fill",
                        color: [0, 0, 0, 0.2],
                        outline: {
                            color: [0, 0, 0, 0.5],
                            width: 2
                        }
                    }
                });
            }

            let carBufferGraphic = undefined
            getCarBuffer().then((buffer) => {
                carBufferGraphic = buffer

                view.graphics.add(carBufferGraphic);
            })

            view.graphics.removeAll()

            view.graphics.add(carGraphic);

            // main loop
            let last = Date.now()
            setInterval(function() {
                const now = Date.now()
                const delta = now - last
                last = now
                carGeometry = {
                    type: "point",
                    longitude: carGraphic.geometry.longitude + 0.0001 * delta,
                    latitude: carGraphic.geometry.latitude
                }
                carGraphic.geometry = new Point(
                    carGeometry
                )
            }, 4000)

            let interesectedGraphics = []

            // buffer loop
            setInterval(function() {
                getCarBuffer().then((buffer) => {
                    view.graphics.remove(carBufferGraphic);
                    carBufferGraphic = buffer
                    view.graphics.add(carBufferGraphic);

                    let query = populationFeatureLayer.createQuery();

                    query.geometry = carBufferGraphic.geometry;
                    query.spatialRelationship = "intersects";
                    query.returnGeometry = true;
                    query.outFields = [ "POPULATION" ];
                    populationFeatureLayer.queryFeatures(query)
                        .then(function(response) {
                            const promises = []

                            // clean up old intersected geometries
                            for (const intersectedGraphic of interesectedGraphics) {
                                view.graphics.remove(intersectedGraphic)
                            }
                            interesectedGraphics = []

                            // draw the intersected geometries
                            for (const feature of response.features) {
                                const intersectedGeometry = feature.geometry
                                const intersectedGeometryGraphic = new Graphic({
                                    geometry: intersectedGeometry,
                                    symbol: {
                                        type: "simple-fill",
                                        color: [0, 0, 0, 0.2],
                                        outline: {
                                            color: [0, 0, 0, 0.5],
                                            width: 2
                                        }
                                    }
                                });

                                interesectedGraphics.push(intersectedGeometryGraphic)
                                view.graphics.add(intersectedGeometryGraphic);
                            }


                            for (const feature of response.features) {
                                promises.push(new Promise(async (resolve, reject) => {
                                    const population = feature.attributes.POPULATION;
                                    const countyGeometry = feature.geometry;

                                    const intersectedGeometriesPromise = GeometryService.intersect(
                                        'http://tasks.arcgisonline.com/arcgis/rest/services/Geometry/GeometryServer',
                                        [countyGeometry],
                                        carBufferGraphic.geometry
                                    ).then((intersectedGeometries) => {
                                        // only 1 geometry
                                        const intersectedGeometry = intersectedGeometries[0]
                                        // calculate area
                                        return GeometryService.areasAndLengths(
                                            'http://tasks.arcgisonline.com/arcgis/rest/services/Geometry/GeometryServer',
                                            new AreasAndLengthsParameters({
                                                lengthUnit: 'kilometers',
                                                areaUnit: 'square-kilometers',
                                                calculationType: 'preserveShape',
                                                polygons: [intersectedGeometry]
                                            })
                                        )
                                    })

                                    const countyAreaPromise = GeometryService.areasAndLengths(
                                        'http://tasks.arcgisonline.com/arcgis/rest/services/Geometry/GeometryServer',
                                        new AreasAndLengthsParameters({
                                            lengthUnit: 'kilometers',
                                            areaUnit: 'square-kilometers',
                                            calculationType: 'preserveShape',
                                            polygons: [countyGeometry]
                                        })
                                    )

                                    const [intersectedGeometryArea, countyArea] = await Promise.all([intersectedGeometriesPromise, countyAreaPromise])
                                    console.log([intersectedGeometryArea, countyArea], 'intersectedGeometryArea, countyArea')
                                    const interesectedRatio = intersectedGeometryArea.areas[0] / countyArea.areas[0]

                                    // return ratio * population
                                    resolve(interesectedRatio * population)
                                }))
                            }

                            Promise.all(promises).then((results) => {
                                const totalPopulation = results.reduce((a, b) => a + b, 0)
                                document.getElementById('total-pop').innerHTML = totalPopulation
                            })

                            // this should not work lol


                        });
                })

                // Get sum of POPULATION_2020 based on the intersect of the buffer with the counties in the feature layer




            }, 4000)

        });
    </script>


</head>
<body>
<div id="viewDiv">
</div>
<div style="position: absolute; top:0; background: beige; border-radius: 10px; padding:10px;">
    <span id="total-pop"/>
</div>
</body>
</html>